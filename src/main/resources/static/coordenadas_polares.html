<!DOCTYPE html>
<html>
<head>
	<title>Coordenadas Polares</title>
	<meta charset="utf-8">
</head>
<body style="background-color: #aaa;">

	<button style="position: absolute; top: 10px; left: 10px;" onclick="mountScene()">Montar Cenário</button>

	<button style="position: absolute; top: 10px; left: 10px; transform: translateX(200px);" onclick="mountLine()">Projetar</button>

	<button style="position: absolute; top: 10px; left: 10px; transform: translateX(400px);" onclick="followLine()">Seguir</button>

	<button id="case1" style="position: absolute; transform: translate(700px,100px);" onclick="cases(this)">Caso 1</button>
	<button id="case2" style="position: absolute; transform: translate(800px,100px);" onclick="cases(this)">Caso 2</button>
	<button id="case3" style="position: absolute; transform: translate(700px,200px);" onclick="cases(this)">Caso 3</button>
	<button id="case4" style="position: absolute; transform: translate(800px,200px);" onclick="cases(this)">Caso 4</button>
	<button id="case5" style="position: absolute; transform: translate(700px,300px);" onclick="cases(this)">Caso 5</button>
	<button id="case6" style="position: absolute; transform: translate(800px,300px);" onclick="cases(this)">Caso 6</button>
	<button id="case7" style="position: absolute; transform: translate(700px,400px);" onclick="cases(this)">Caso 7</button>
	<button id="case8" style="position: absolute; transform: translate(800px,400px);" onclick="cases(this)">Caso 8</button>

	<svg width="800" height="800">

		<path d="M 1,100 H 20 M 1,100 V 200 M 1,200 H 20 M 1,200 V 300 M 1,300 H 20 M 1,300 V 400 M 1,400 H 20 M 1,400 V 500 M 1,500 H 20 M 1,500 V 600" stroke="black" stroke-width="3"/>

		<path d="M 1,600H 100 M 100,600 V 580 M 100,600 H 200 M 200,600 V 580 M 200,600 H 300 M 300,600 V 580 M 300,600 H 400 M 400,600 V 580 M 400,600 H 500 M 500,600 V 580 M 500,600 H 600 M 600,600 V 580" stroke="black" stroke-width="3" />

		<g id="arrow" fill="black" transform="rotate(0)">
			<path d="M 0,0 V 20 L 30,10 z"/>
		</g>

        <path id="line" d="M100,300 Q183,424 133,564" stroke="black" stroke-width="5" fill="transparent"></path>

		<text x="20" y="105"> 100 </text>
		<text x="20" y="205"> 200 </text>
		<text x="20" y="305"> 300 </text>
		<text x="20" y="405"> 400 </text>
		<text x="20" y="505"> 500 </text>

		<text x="90" y="575"> 100 </text>
		<text x="190" y="575"> 200 </text>
		<text x="290" y="575"> 300 </text>
		<text x="390" y="575"> 400 </text>
		<text x="490" y="575"> 500 </text>
		<text x="590" y="575"> 600 </text>

	</svg>

	<script type="text/javascript">

		var x1;
		var y1;
		var x2;
		var y2;

		function cases(e){
			if (e.id == "case1"){
				x1 = 100;
				y1 = 300;
				x2 = 500;
				y2 = 200;
			}else if (e.id == "case2"){
				x1 = 100;
				y1 = 200;
				x2 = 500;
				y2 = 300;
			}else if (e.id == "case3"){
				x1 = 500;
				y1 = 200;
				x2 = 100;
				y2 = 300;
			}else if (e.id == "case4"){
				x1 = 500;
				y1 = 300;
				x2 = 100;
				y2 = 200;
			}else if (e.id == "case5"){
				x1 = 100;
				y1 = 200;
				x2 = 500;
				y2 = 200;
			}else if (e.id == "case6"){
				x1 = 500;
				y1 = 200;
				x2 = 100;
				y2 = 200;
			}else if (e.id == "case7"){
				x1 = 200;
				y1 = 100;
				x2 = 200;
				y2 = 500;
			}else if (e.id == "case8"){
				x1 = 200;
				y1 = 500;
				x2 = 200;
				y2 = 100;
			}
		}

		function mountScene (argument) {

			var svg = document.getElementsByTagName("svg")[0];
			var line = document.createElementNS(
				'http://www.w3.org/2000/svg', 'line');
			svg.appendChild(line);
			line.setAttribute("x1", x1);
			line.setAttribute("y1", y1);
			line.setAttribute("x2", x2);
			line.setAttribute("y2", y2);
			line.setAttribute("stroke", "black");
			line.setAttribute("stroke-width", "5");

			var dot1 = document.createElementNS(
				'http://www.w3.org/2000/svg', 'circle');
			svg.appendChild(dot1);
			dot1.setAttribute("cx", x1);
			dot1.setAttribute("cy", y1);
			dot1.setAttribute("r", 15);
			dot1.setAttribute("fill", "blue");

			var dot2 = document.createElementNS(
				'http://www.w3.org/2000/svg', 'circle');
			svg.appendChild(dot2);
			dot2.setAttribute("cx", x2);
			dot2.setAttribute("cy", y2);
			dot2.setAttribute("r", 15);
			dot2.setAttribute("fill", "blue");

		}

		function calcPolarCoord(x1, y1, x2, y2){

			// Distância entre os pontos no eixo X 
			var Dx = x2 - x1;
			// Distância entre os pontos no eixo Y
			var Dy = y2 - y1;

			//console.log('Dx:' + Dx);
			//console.log('Dy:' + Dy);

			// teta é o ângulo em radianos 

			if ( x1 === x2 ){
				var teta = 0;
			}else if ( y1 === y2 ) {
				var teta = Math.PI/2;
			}else{
				var teta = Math.atan(Dx/Dy);
			}

			//console.log('Teta (ângulo):' + teta);

			// Coordenadas do ponto (x,y) entre os outros pontos
			var Xm = (x2 + x1) / 2;
			var Ym = (y2 + y1) / 2;

			//console.log('Xm ( Ponto Médio ):' + Xm);
			//console.log('Ym ( Ponto Médio ):' + Ym);

			/* r é a altura da curva que será a metade
				de 25% da distancias entres os pontos
				(12.5% da distância) */
			var r = Math.sqrt( Math.pow(Dx, 2) + Math.pow(Dy, 2) ) * 0.25;	 
			//console.log('Raio (altura):' + r);

			console.log(r*Math.cos(teta));

			/* Calculo do ponto de elevação da transição
				usando coordenadas polares*/
			// x = r*cos(a)
			// y = r*sin(a)
			/* Como em geral, o ponto medio dos pontos das
				extremidades da transição não vai estar no
				(x,y) = (0,0), então suas coordenadas são
				somadas as obtidas anteriormente */
			// x = Xm +/- r*cos(a)
			// y = Ym +/- r*sin(a)
			/* +/- depende da localização dos pontos de extremidade */
			if (x1 < x2 && y1 > y2){
				var x = Math.round(Xm - r*Math.cos(teta));
				var y = Math.round(Ym + r*Math.sin(teta));
				var x_Marker = Math.round(Xm - ((r+20)/2)*Math.cos(teta));
				var y_Marker = Math.round(Ym + ((r+20)/2)*Math.sin(teta));
			}
			else if (x1 < x2 && y1 <= y2){
				var x = Math.round(Xm + r*Math.cos(teta));
				var y = Math.round(Ym - r*Math.sin(teta));
				var x_Marker = Math.round(Xm + ((r+20)/2)*Math.cos(teta));
				var y_Marker = Math.round(Ym - ((r+20)/2)*Math.sin(teta));
			}
			else if (x1 > x2 && y1 < y2){
				var x = Math.round(Xm - (-r)*Math.cos(teta));
				var y = Math.round(Ym + (-r)*Math.sin(teta));
				var x_Marker = Math.round(Xm - (((-r)-20)/2)*Math.cos(teta));
				var y_Marker = Math.round(Ym + (((-r)-20)/2)*Math.sin(teta));
			}
			else if (x1 > x2 && y1 >= y2){
				var x = Math.round(Xm + (-r)*Math.cos(teta));
				var y = Math.round(Ym - (-r)*Math.sin(teta));
				var x_Marker = Math.round(Xm + (((-r)-20)/2)*Math.cos(teta));
				var y_Marker = Math.round(Ym - (((-r)-20)/2)*Math.sin(teta));
			}else{
				if (y1 < y2){
					var x = Math.round(Xm + r*Math.cos(teta));
					var y = Math.round(Ym - r*Math.sin(teta));
					var x_Marker = Math.round(Xm + ((r+20)/2)*Math.cos(teta));
					var y_Marker = Math.round(Ym - ((r+20)/2)*Math.sin(teta));
				}else{
					var x = Math.round(Xm + (-r)*Math.cos(teta));
					var y = Math.round(Ym - (-r)*Math.sin(teta));
					var x_Marker = Math.round(Xm + (((-r)-20)/2)*Math.cos(teta));
					var y_Marker = Math.round(Ym - (((-r)-20)/2)*Math.sin(teta));
				}
			}

			// retorna um dicionário(objeto) com os valores obtidos
			return { "x" : x , "y" : y , "Xm" : Xm, "Ym" : Ym, "teta" : teta, "x_Marker" : x_Marker, "y_Marker" : y_Marker };

		}
		
		function mountLine() {

			var coord = calcPolarCoord(x1,y1,x2,y2);

			var x = coord.x;
			var y = coord.y;
			var Xm = coord.Xm;
			var Ym = coord.Ym;
			var x_Marker = coord.x_Marker;
			var y_Marker = coord.y_Marker;
			var teta = coord.teta;

			//console.log('x: ' + x);
			//console.log('y: ' + y);

			var svg = document.getElementsByTagName("svg")[0];
			var line = document.createElementNS(
				'http://www.w3.org/2000/svg', 'line');
			svg.appendChild(line);
			line.setAttribute("x1", Xm);
			line.setAttribute("y1", Ym);
			line.setAttribute("x2", x);
			line.setAttribute("y2", y);
			line.setAttribute("stroke", "black");
			line.setAttribute("stroke-width", "5");

			var dot1 = document.createElementNS(
				'http://www.w3.org/2000/svg', 'circle');
			svg.appendChild(dot1);
			dot1.setAttribute("cx", Xm);
			dot1.setAttribute("cy", Ym);
			dot1.setAttribute("r", 15);
			dot1.setAttribute("fill", "blue");

			var dot2 = document.createElementNS(
				'http://www.w3.org/2000/svg', 'circle');
			svg.appendChild(dot2);
			dot2.setAttribute("cx", x);
			dot2.setAttribute("cy", y);
			dot2.setAttribute("r", 15);
			dot2.setAttribute("fill", "blue");

			var pat = document.createElementNS(
				'http://www.w3.org/2000/svg', 'path');
			svg.appendChild(pat);
			pat.setAttribute("id", "line");
			
			var d = "M" + x1 + "," + y1 + " Q" + x + "," + y + " " + x2 + "," + y2;
			
			pat.setAttribute("d", d);
			pat.setAttribute("stroke", "black");
			pat.setAttribute("stroke-width", "5");
			pat.setAttribute("fill", "transparent");

			var ang = calcAngMarker(teta,x1,x2,y1,y2);

			var marker = document.getElementById("arrow").cloneNode(true);
			marker.setAttribute("id", "marker");
			marker.setAttribute("transform", "translate(" + x_Marker + " " + y_Marker +") rotate (" + ang + ")");
			svg.appendChild(marker);

		}

		function calcAngMarker(teta, x1, x2, y1, y2){

			// Calcula a orientação do marcador
			/* A orientação de teta é relacionada
				ao ângulo entre a reta que que sai
				do ponto médio dos pontos de extremidade
				em relação ao eixo x, sendo assim,
				necessário um ajuste de 90 ou 270 graus.*/
			if (y1 < y2 && x1 != x2) {
				return 90-(teta*180)/Math.PI;	
			}else if(y1 > y2 && x1 != x2){
				return 270-(teta*180)/Math.PI;
			}

			if (y1 === y2 && x1 < x2){
				return 0;
			}else if(y1 === y2 && x1 > x2){
				return 180;
			}

			if (x1 === x2 && y1 < y2) {
				return 90;
			}else if(x1 === x2 && y1 > y2){
				return 270;
			}

		}

		function followLine (e) {

			document.getElementsByTagName("body")[0].addEventListener("mousemove",
				function (e) {

					var coord = calcPolarCoord(x1,y1,e.clientX, e.clientY);

					var x = coord.x;
					var y = coord.y;
					var x_Marker = coord.x_Marker;
					var y_Marker = coord.y_Marker;
					var teta = coord.teta;
			
					var line = document.getElementById("line");
					console.log(line);
					var d = line.getAttribute("d");
					console.log(d);

					d = d.slice(0,d.lastIndexOf("Q")+1) + x + "," + y + " " + e.clientX + "," + e.clientY;
					console.log(d);
					line.setAttribute("d", d);

					var ang = calcAngMarker(teta, x1, e.clientX, y1, e.clientY);

					var marker = document.getElementById("marker");
					marker.setAttribute("transform", "translate(" + x_Marker + " " + y_Marker +") rotate (" + ang + ")");

				}, false);

		}

	</script>

</body>
</html>
